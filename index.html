<!DOCTYPE html>
<html>
  <head>
    <title>Fridge Dashboard</title>
    <meta charset="UTF-8" />
    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
        text-align: center;
      }
      canvas {
        width: 100%;
        max-width: 800px;
        margin: auto;
      }
    </style>
  </head>
  <body>
    <h1>Fridge Dashboard</h1>
    <label>Show data from the past: 
      <select id="time-range">
        <option value="6">6 hours</option>
        <option value="12">12 hours</option>
        <option value="24" selected>24 hours</option>
        <option value="48">48 hours</option>
      </select>
    </label>

    <canvas id="chart"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const ctx = document.getElementById('chart').getContext('2d');

      let chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: []
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: 'Time' } },
            y: { title: { display: true, text: 'Value' } }
          }
        }
      });

      async function loadChartData(hours = 24) {
        try {
          const res = await fetch(`/api/history?hours=${hours}`);
          const data = await res.json();

          const labels = [];
          const datasets = {
            temperature: { label: 'Temperature (Â°C)', borderColor: 'red', data: [], fill: false },
            humidity: { label: 'Humidity (%)', borderColor: 'blue', data: [], fill: false },
            battery: { label: 'Battery (%)', borderColor: 'orange', data: [], fill: false }
          };

          data.forEach(sensorData => {
            sensorData.forEach(entry => {
              const time = new Date(entry.last_changed).toLocaleTimeString();
              if (!labels.includes(time)) labels.push(time);

              if (entry.entity_id.includes('temperature')) {
                datasets.temperature.data.push({ x: time, y: parseFloat(entry.state) });
              } else if (entry.entity_id.includes('humidity')) {
                datasets.humidity.data.push({ x: time, y: parseFloat(entry.state) });
              } else if (entry.entity_id.includes('battery')) {
                datasets.battery.data.push({ x: time, y: parseFloat(entry.state) });
              }
            });
          });

          chart.data.labels = labels;
          chart.data.datasets = Object.values(datasets);
          chart.update();
        } catch (err) {
          console.error('Error loading data:', err);
        }
      }

      // Initial load
      loadChartData();

      // Change range
      document.getElementById('time-range').addEventListener('change', (e) => {
        const selectedHours = parseInt(e.target.value);
        loadChartData(selectedHours);
      });
    </script>
  </body>
</html>
