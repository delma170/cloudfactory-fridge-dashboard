<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cloud Factory Fridge Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: sans-serif;
        background-color: #f5f5f5;
        text-align: center;
        padding: 2rem;
      }
      h1 {
        font-size: 2.5rem;
        margin-bottom: 2rem;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: #fff;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
      }
      canvas {
        margin: 2rem 0;
      }
    </style>
  </head>
  <body>
    <h1>Cloud Factory Fridge Dashboard</h1>
    <div class="container">
      <label for="period">Select period:
        <select id="period">
          <option value="1">1 Hour</option>
          <option value="6">6 Hours</option>
          <option value="12">12 Hours</option>
          <option value="24" selected>24 Hours</option>
          <option value="48">48 Hours</option>
        </select>
      </label>
      <canvas id="fridgeChart"></canvas>
    </div>

    <script>
      const ctx = document.getElementById('fridgeChart').getContext('2d');
      let chart;

      const colorZones = {
        temperature: { safe: [0, 10], warn: [10, 15], alert: [15, 100] },
        humidity: { safe: [30, 60], warn: [20, 30], alert: [0, 20] },
        battery: { safe: [50, 100], warn: [20, 50], alert: [0, 20] }
      };

      function getColor(value, type) {
        const { safe, warn, alert } = colorZones[type];
        if (value >= safe[0] && value <= safe[1]) return 'green';
        if (value >= warn[0] && value <= warn[1]) return 'orange';
        return 'red';
      }

      async function fetchData(hours) {
        const res = await fetch(`/api/fridge?hours=${hours}`);
        const data = await res.json();
        return data;
      }

      function drawChart(data) {
        const labels = data.timestamps;
        const datasets = [
          {
            label: 'Temperature (Kitchen)',
            data: data.kitchen.temperature,
            borderColor: 'red',
            backgroundColor: data.kitchen.temperature.map(v => getColor(v, 'temperature')),
            fill: false,
          },
          {
            label: 'Humidity (Kitchen)',
            data: data.kitchen.humidity,
            borderColor: 'blue',
            backgroundColor: data.kitchen.humidity.map(v => getColor(v, 'humidity')),
            fill: false,
          },
          {
            label: 'Battery (Kitchen)',
            data: data.kitchen.battery,
            borderColor: 'goldenrod',
            backgroundColor: data.kitchen.battery.map(v => getColor(v, 'battery')),
            fill: false,
          }
        ];

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: { display: true, text: 'Kitchen Fridge Sensors' },
            },
            scales: {
              y: {
                title: { display: true, text: 'Value' }
              },
              x: {
                title: { display: true, text: 'Time' }
              }
            }
          }
        });
      }

      async function updateChart() {
        const hours = document.getElementById('period').value;
        const data = await fetchData(hours);
        drawChart(data);
      }

      document.getElementById('period').addEventListener('change', updateChart);

      updateChart();
    </script>
  </body>
</html>
